<launch>

  <arg name="mav_name" value="hmcl"/>

<!-- Drone visualization in Rviz St0art-->
  <arg name="color/r" default="0.0"/>
  <arg name="color/g" default="0.0"/>
  <arg name="color/b" default="1.0"/>
  <arg name="color/a" default="0.7"/>
  <arg name="mesh_name" default="hummingbird"/>
  <arg name="odom_topic" default="/mavros/local_position/odom"/>
<!-- Drone visualization in Rviz End -->

<!-- Main Algorithm Start-->
  <!-- <arg name="odom_topic" default="$(arg odom_topic)"/> -->
  <arg name="sensor_pose_topic" value="/hmcl/camera_pose"/>
  <arg name="pose_type" default="1"/>  <!-- 1 for pose topic type, 2 for odom topic type-->
  <!-- <arg name="depth_topic" value="$(arg original_depth_image)"/> -->
  <arg name="cloud_topic" value="/voxel_grid/output"/>
  <arg name="waypoints_topic" default="/waypoint_generator/waypoints"/>
  <arg name="tracker_topic" value="/$(arg mav_name)/trackers_manager/poly_tracker/PolyTracker/goal"/>
  <arg name="srv_name"  value="/$(arg mav_name)/mav_services/poly_tracker"/>
  <arg name="frame_id" default="map"/>
  <arg name="map_size_x_" default="40"/>
  <arg name="map_size_y_" default="40"/>
  <arg name="map_size_z_" default="3"/>
  <arg name="map_origin_x_" default="-20.0"/>
  <arg name="map_origin_y_" default="-20.0"/>
  <arg name="map_origin_z_" default="-0.1"/>
  <arg name="box_min_x" default="-20.0"/>
  <arg name="box_min_y" default="-20.0"/>
  <arg name="box_min_z" default=" -0.1"/>
  <arg name="box_max_x" default="20.0"/>
  <arg name="box_max_y" default="20.0"/>
  <arg name="box_max_z" default="2.9"/>
  <arg name="max_vel" default="0.5" />
  <arg name="max_acc" default="0.5" />

<!-- Main Algorithm End-->1

<!-- Camera FOV visualization in Rviz End-->  
  <node pkg="odom_visualization" name="odom_visualization" type="odom_visualization" output="screen" launch-prefix="nice -n 1">
    <remap from="~odom" to="$(arg odom_topic)"/>
    <param name="color/a" value="1.0"/>    
    <param name="color/r" value="0.0"/>        
    <param name="color/g" value="0.0"/>        
    <param name="color/b" value="1.0"/>
    <param name="frame_id" value="$(arg frame_id)"/>       
    <param name="covariance_scale" value="100.0"/>       
    <param name="robot_scale" value="1.0"/>
  </node>
<!-- Camera FOV visualization in Rviz End-->  

<!-- Waypoint generation Start-->
  <node pkg="waypoint_generator" name="waypoint_generator" type="waypoint_generator" output="screen" launch-prefix="nice -n 1">
    <remap from="~odom" to="$(arg odom_topic)"/>        
    <remap from="~goal" to="/move_base_simple/goal"/>
    <remap from="~traj_start_trigger" to="/traj_start_trigger" />
    <param name="waypoint_type" value="point"/>
    <param name="frame_id" value="$(arg frame_id)"/>
  </node>
<!-- Waypoint generation End-->
    
  <group ns="$(arg mav_name)">
  <!-- Drone visualization in Rviz Start-->  
    <include file="$(find kr_mav_launch)/launch/mesh_vis.launch">
      <arg name="mesh_name" value="$(arg mesh_name)"/>
      <arg name="odom_topic" value="$(arg odom_topic)"/>
      <arg name="color/r" value="$(arg color/r)"/>
      <arg name="color/g" value="$(arg color/g)"/>
      <arg name="color/b" value="$(arg color/b)"/>
      <arg name="color/a" value="$(arg color/a)"/>
    </include>
  <!-- Drone visualization in Rviz End--> 

  <!-- Main Algorithm Start-->  
    <node pkg="exploration_manager" name="exploration_node" type="exploration_node" output="screen" >
      <remap from ="/odom_world" to="$(arg odom_topic)"/>
      <remap from ="/map_ros/pose"  to = "$(arg sensor_pose_topic)"/> 
      <!-- <remap from ="/map_ros/depth" to = "$(arg depth_topic)"/> -->
      <remap from ="/map_ros/cloud" to = "$(arg cloud_topic)"/>
      <remap from="~waypoints"  to= "$(arg waypoints_topic)"/>
      <remap from="~tracker_cmd"  to="$(arg tracker_topic)"/>
      <param name="srv_name"     value="$(arg srv_name)"/>
      <param name="plan_frame_id"  value ="$(arg frame_id)"/>
    
      <param name="sdf_map/resolution"      value="0.2" /> 
      <param name="sdf_map/map_size_x"   value="$(arg map_size_x_)" /> 
      <param name="sdf_map/map_size_y"   value="$(arg map_size_y_)" /> 
      <param name="sdf_map/map_size_z"   value="$(arg map_size_z_)" /> 

      <param name="sdf_map/map_origin_x"   value="$(arg map_origin_x_)" /> 
      <param name="sdf_map/map_origin_y"   value="$(arg map_origin_y_)" /> 
      <param name="sdf_map/map_origin_z"   value="$(arg map_origin_z_)" /> 

    <!-- Global map inflation -->
      <param name="sdf_map/inflation_xy"     value="0.8" /> 
      <param name="sdf_map/inflation_z"     value="0.15" /> 

    <!-- Local map inflation -->
      <param name="sdf_map/inflate_local" value="false" type="bool"/> 
      <param name="sdf_map/obstacles_inflation"     value="0.8" /> 
      <param name="sdf_map/local_bound_inflate"    value="0.5"/>
      <param name="sdf_map/local_map_margin"      value="50"/>
    <!-- <param name="sdf_map/obstacles_inflation"     value="0.099" />  -->
      <param name="sdf_map/ground_height"        value="0.0"/>
      <param name="sdf_map/default_dist"        value="0.0"/>
      
      <param name="sdf_map/p_hit"  value="0.70"/>
      <param name="sdf_map/p_miss" value="0.35"/>
      <param name="sdf_map/p_min"  value="0.12"/>
      <param name="sdf_map/p_max"  value="0.97"/>
      <param name="sdf_map/p_occ"  value="0.80"/>
      <param name="sdf_map/p_pred_occ"  value="0.65"/>
      <param name="sdf_map/min_ray_length" value="0.1"/>
      <param name="sdf_map/max_ray_length" value="10.0"/>
      <param name="sdf_map/virtual_ceil_height"   value="-10"/>
      <param name="sdf_map/optimistic" value="false" type="bool"/>
      <param name="sdf_map/signed_dist" value="false" type="bool"/>
      <param name="sdf_map/box_min_x" value="$(arg box_min_x)" type="double"/>
      <param name="sdf_map/box_min_y" value="$(arg box_min_y)" type="double"/>
      <param name="sdf_map/box_min_z" value="$(arg box_min_z)" type="double"/>
      <param name="sdf_map/box_max_x" value="$(arg box_max_x)" type="double"/>
      <param name="sdf_map/box_max_y" value="$(arg box_max_y)" type="double"/>
      <param name="sdf_map/box_max_z" value="$(arg box_max_z)" type="double"/>

      <param name="map_ros/esdf_slice_height" value="0.3"/>
      <param name="map_ros/visualization_truncate_height"   value="10.09"/>
      <param name="map_ros/visualization_truncate_low"   value="-2.0"/>
      <param name="map_ros/show_occ_time"  value="false"/>
      <param name="map_ros/show_esdf_time" value="false"/>
      <param name="map_ros/show_all_map" value="true"/>
      <param name="map_ros/frame_id"      value="$(arg frame_id)"/>
      <param name="map_ros/pose_type"     value="$(arg pose_type)"/>

    <!-- Fsm -->
      <param name="fsm/thresh_replan1" value="0.8" type="double"/>
      <param name="fsm/thresh_replan2" value="2.0" type="double"/>
      <param name="fsm/thresh_replan3" value="1.5" type="double"/>
      <param name="fsm/estop_time"     value="0.8" type="double"/>
      <!-- <param name="fsm/thresh_replan1" value="0.00001" type="double"/> -->
      <!-- <param name="fsm/thresh_replan2" value="100.0" type="double"/> -->
      <!-- <param name="fsm/thresh_replan3" value="0.1" type="double"/> -->
      <param name="fsm/replan_time" value="0.3" type="double"/>

    <!-- Exploration manager -->
      <param name="exploration/refined_radius" value="5.0" type="double"/>
      <param name="exploration/max_decay" value="0.8" type="double"/>
      <param name="exploration/top_view_num" value="15" type="int"/>
      <param name="exploration/vm" value="$(eval 1.0 * arg('max_vel'))" type="double"/>
      <param name="exploration/am" value="$(eval 1.0 * arg('max_acc'))" type="double"/>
      <param name="exploration/yd" value="$(eval 60 * 3.1415926 / 180.0)" type="double"/>
      <param name="exploration/ydd" value="$(eval 90 * 3.1415926 / 180.0)" type="double"/>
      <param name="exploration/w_dir" value="1.5" type="double"/>
      <param name="exploration/relax_time" value="2.0" type="double"/>
      <param name="exploration/detect_semantics" value="false" type="bool"/>
      
      <param name="exploration/radius_far"    value="5.0" type="double"/>
      <param name="exploration/radius_close"  value="3.0" type="double"/>
      <param name="exploration/radius_noplan" value="0.5" type="double"/>

      <param name="exploration/terminate_condition_vol_enabled" value="true" type="bool"/>
      <param name="exploration/terminate_condition_vol" value="248.0" type="double"/>
      
      <param name="frontier/exp_3d" value="false" type="bool"/>
      <param name="frontier/cluster_min" value="100" type="int"/>
      <param name="frontier/cluster_size_xy" value="1.2" type="double"/>
      <param name="frontier/cluster_size_z" value="3.0" type="double"/>
      <param name="frontier/room_min_candidate_dist" value="0.20" type="double"/>
      <param name="frontier/min_candidate_dist" value="0.75" type="double"/>
      <param name="frontier/min_candidate_obs_clearance" value="0.3" type="double"/>
      <param name="frontier/min_candidate_clearance" value="0.4" type="double"/>

      <param name="frontier/candidate_dphi" value="$(eval 15 * 3.1415926 / 180.0)" type="double"/>
      <param name="frontier/candidate_rnum" value="3" type="int"/>
      <param name="frontier/candidate_rmin" value="0.5" type="double"/>
      <param name="frontier/candidate_rmax" value="1.2" type="double"/>
      <!-- <param name="frontier/candidate_rnum" value="3" type="int"/> -->
      <!-- <param name="frontier/candidate_rmin" value="1.5" type="double"/> -->
      <!-- <param name="frontier/candidate_rmax" value="2.5" type="double"/> -->
      <param name="frontier/down_sample" value="3" type="int"/>;
      <param name="frontier/min_visib_num" value="12" type="int"/>;
      <param name="frontier/min_info_gain" value="500" type="int"/>;
      <param name="frontier/min_view_finish_fraction" value="0.2" type="double"/>;
      <param name="frontier/h_fov" value="1.36" type="double"/>;
      <param name="frontier/v_fov" value="0.906" type="double"/>;
      <param name="frontier/min_ray_length" value="0.1" type="double"/>;
      <param name="frontier/max_ray_length" value="10.0" type="double"/>;
      <remap from="frontier/occ_map/pred" to="/frontier/occ_map/pred" />
      <param name="frontier/pred_size_x" value="40" type="int"/>;
      <param name="frontier/pred_size_y" value="40" type="int"/>;
      <param name="frontier/pred_size_z" value="24" type="int"/>;

    <!-- Door detection related param -->
      <param name="frontier/door_confirm_thres" value="1.2" type="double"/>;
      <param name="frontier/door_cross_thres" value="1.2" type="double"/>;
      <param name="frontier/door_exit_thres" value="1.2" type="double"/>;
      <param name="frontier/door_confirm_dis" value="1.0" type="double"/>;
      <param name="frontier/door_cross_dis" value="2.0" type="double"/>;
      <param name="frontier/door_exit_dis" value="1.0" type="double"/>;
      <param name="frontier/min_vote" value="5" type="int"/>; 
      <param name="frontier/h_min_line_length" value="3" type="double"/>;
      <param name="frontier/h_max_line_gap" value="5" type="double"/>;
      <param name="frontier/v_min_line_length" value="10" type="double"/>;
      <param name="frontier/v_max_line_gap" value="6" type="double"/>;
      <param name="frontier/h_min_door" value="9" type="double"/>;
      <param name="frontier/h_max_door" value="16" type="double"/>;
      <param name="frontier/v_min_door" value="9" type="double"/>;
      <param name="frontier/v_max_door" value="16" type="double"/>;

    <!-- Perception utils -->
      <param name="perception_utils/top_angle" value="0.56125" type="double"/>;
      <param name="perception_utils/left_angle" value="0.69222" type="double"/>;
      <param name="perception_utils/right_angle" value="0.68901" type="double"/>;
      <param name="perception_utils/max_dist" value="3.0" type="double"/>;
      <param name="perception_utils/vis_dist" value="1.0" type="double"/>;


      <param name="heading_planner/yaw_diff" value="$(eval 30 * 3.1415926 / 180.0)" type="double"/>
      <param name="heading_planner/half_vert_num" value="5" type="int"/>
      <param name="heading_planner/lambda1" value="2.0" type="double"/>
      <param name="heading_planner/lambda2" value="1.0" type="double"/>
      <param name="heading_planner/max_yaw_rate" value="$(eval 10 * 3.1415926 / 180.0)" type="double"/>
      <param name="heading_planner/w" value="20000.0" type="double"/>
      <param name="heading_planner/weight_type" value="1" type="double"/>

    <!-- planner manager -->
      <param name="manager/max_vel" value="$(arg max_vel)" type="double"/>
      <param name="manager/max_acc" value="$(arg max_acc)" type="double"/>
      <param name="manager/max_jerk" value="3" type="double"/>
      <param name="manager/max_dyaw" value="$(eval 60 * 3.1415926 / 180.0)" type="double"/>
      <param name="manager/max_ddyaw" value="$(eval 90 * 3.1415926 / 180.0)" type="double"/>

    <!-- kinodynamic path searching -->
      <param name="manager/use_astar_path" value="true" type="bool"/>
      <param name="manager/use_kino_acc_path" value="true" type="bool"/>
      <param name="manager/min_time" value="true" type="bool"/>
    
      <param name="manager/map_size_x"   value="$(arg map_size_x_)" /> 
      <param name="manager/map_size_y"   value="$(arg map_size_y_)" /> 

    <!-- planning ceilings -->
      <param name="manager/map_size_z"   value="2.2" /> 
      <param name="manager/map_origin_x"   value="$(arg map_origin_x_)" /> 
      <param name="manager/map_origin_y"   value="$(arg map_origin_y_)" /> 
      <param name="manager/map_origin_z"   value="$(arg map_origin_z_)" /> 
      <param name="manager/time_res"   value="0.2" /> 


    <!-- kinodynamic path searching -->
      <param name="search/max_tau" value="0.6" type="double"/>
      <param name="search/init_max_tau" value="0.6" type="double"/>
      <param name="search/max_vel" value="$(arg max_vel)" type="double"/>
      <param name="search/max_acc" value="$(arg max_acc)" type="double"/>
      <param name="search/max_jerk" value="3" type="double"/>
      <param name="search/w_time" value="3.0" type="double"/>
      <param name="search/horizon" value="8.0" type="double"/>
      <param name="search/lambda_heu" value="5.0" type="double"/>
      <param name="search/resolution_astar" value="0.1" type="double"/>
      <param name="search/margin" value="0.2" type="double"/>
      <param name="search/allocate_num" value="100000" type="int"/>
      <param name="search/optimistic" value="false" type="bool"/>
      <param name="search/vis_check_num" value="15" type="int"/>

      <param name="search/w_uyaw" value="3.0" type="double"/>
      <param name="search/w_semantics" value="1.0" type="double"/>
      <param name="search/w_info" value="0.004" type="double"/>
      <param name="search/yaw_resolution"  value="0.1" type="double"/>
      <param name="search/max_search_time" value="0.03" type="double"/>

      <param name="astar/lambda_heu" value="2.0" type="double"/>
      <param name="astar/resolution_astar" value="0.2" type="double"/>
      <param name="astar/allocate_num" value="1000000" type="int"/>
      <param name="astar/max_search_time" value="0.05" type="double"/>

    <!-- optimization -->
      <param name="optimization/w_time"     value="0.5" type="double"/>
      <param name="optimization/w_vel"      value="10000.0" type="double"/>
      <param name="optimization/w_acc"      value="10000.0" type="double"/>
      <param name="optimization/w_sta_obs"  value="20.0" type="double"/>

      <param name="optimization/w_yaw_time"     value="1.0" type="double"/>
      <param name="optimization/w_refyaw"       value="40.0" type="double"/>
      <param name="optimization/w_dyaw"         value="2000.0" type="double"/>
      <param name="optimization/w_ddyaw"        value="4000.0" type="double"/>
    </node>
  <!-- Main Algorithm End-->

  </group>


</launch>
